# Copilot Instructions for SimpleCov Resultset Diff Action

## Project Overview
This is a GitHub Action that compares SimpleCov coverage reports between base and head branches, posting diff results as PR comments. The action processes Ruby SimpleCov `.resultset.json` files and generates visual markdown tables with coverage changes.

## Architecture
- **Entry Point**: `src/index.ts` → `src/main.ts` → `run()` function
- **Core Logic**: `src/simplecov.ts` - Coverage parsing and diff calculation
- **Utilities**: `src/utils.ts` - File handling, formatting, and badge generation
- **Distribution**: Built to `dist/index.js` using `@vercel/ncc` for GitHub Actions runtime

## Key Data Flows
1. GitHub Action inputs → `core.getInput()` for resultset paths and token
2. Parse SimpleCov JSON → `Coverage` class instances for base/head
3. Generate diff → `getCoverageDiff()` compares line and branch coverage
4. Format output → Markdown table with visual badges from `assets/` directory
5. Post comment → GitHub API via `@actions/github` octokit

## SimpleCov Format Understanding
- **Resultset structure**: `{[command]: {coverage: {[filename]: {lines: [], branches: {}}}}}`
- **Line coverage**: Array of `number | null` (null = not executable, 0 = uncovered, >0 = hit count)
- **Branch coverage**: Nested object `{[condition]: {[branch]: hitCount}}`
- Coverage percentages calculated in `simplecov.ts` using `floor()` precision

## Development Patterns
- **Testing**: Jest with fixtures in `__tests__/fixtures/` containing real resultset examples
- **Mocking**: Mock `@actions/core` and `@actions/github` for isolated unit tests
- **Building**: `npm run bundle` → format, lint, test, package in one command
- **Packaging**: Use `npm run package` to rebuild `dist/` after src changes

## Critical Workflows
```bash
# Development iteration
npm test                    # Run Jest tests
npm run package:watch       # Auto-rebuild on changes
npm run bundle             # Full build pipeline

# Before commit
npm run all                # Format, lint, test, coverage, package
```

## Badge Generation System
The `assets/` directory contains auto-generated SVG badges for coverage deltas:
- `assets/up/X/X.Y.svg` for increases
- `assets/down/X/X.Y.svg` for decreases  
- Generated by `scripts/gen_svg.rb` (Ruby script)
- Referenced in `utils.ts:badgeUrl()` for markdown embedding

## Error Handling Patterns
- File existence validation via `doesPathExists()` before parsing
- JSON parsing failures bubble up as runtime errors
- GitHub API errors caught in main `run()` function with `core.setFailed()`
- Test environment uses `NODE_ENV === 'test'` to mock filesystem paths

## Testing Conventions
- Use real SimpleCov fixture files for integration-style tests
- Mock external dependencies (`@actions/*`) but not internal logic
- Test both difference and no-difference scenarios
- Include error cases (missing files, invalid JSON)

## Action Configuration
- Inputs defined in `action.yml`: base-resultset-path, head-resultset-path, token
- Runs on Node.js 20 via GitHub Actions runtime
- Output posted as PR comment, not action outputs
